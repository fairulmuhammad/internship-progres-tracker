<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Internship Tracker</title>
    
    <style>
        /* Import main styles first */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --secondary-color: #6b7280;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --background-color: #f3f4f6;
            --card-background: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #d1d5db;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* App Layout */
        .app-container {
            min-height: 100vh;
        }

        /* Header */
        .main-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: var(--shadow-md);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .breadcrumb a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            color: white;
        }

        .breadcrumb-separator {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
        }

        /* Analytics Page Specific Styles */
        .analytics-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-header h1 {
            font-size: 2.5rem;
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-weight: 700;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin: 0;
        }

        /* Analytics Filter Tabs */
        .analytics-filter-tabs {
            margin: 2rem 0;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .filter-tabs {
            display: flex;
            background: #f8fafc;
        }
        
        .filter-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #64748b;
            position: relative;
        }
        
        .filter-tab:hover {
            background: #e2e8f0;
            color: #475569;
        }
        
        .filter-tab.active {
            background: #ffffff;
            color: #1e293b;
            box-shadow: 0 -2px 0 #4f46e5 inset;
        }
        
        .filter-tab.active::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #4f46e5;
        }
        
        .tab-icon {
            font-size: 1.25rem;
        }
        
        .tab-text {
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Stats Section */
        .stats-section,
        .task-analytics-section,
        .timeline-section,
        .heatmap-section {
            margin-bottom: 3rem;
        }

        .stats-section h2,
        .task-analytics-section h2,
        .timeline-section h2,
        .heatmap-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: var(--card-background);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .stat-content h3 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0 0 0.25rem 0;
        }

        .stat-content p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .chart-card {
            background: var(--card-background);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .chart-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        /* Completion Rate Circle */
        .completion-chart {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .circular-progress {
            position: relative;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
        }

        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success-color);
        }

        /* Status/Priority Breakdown */
        .status-breakdown,
        .priority-breakdown,
        .category-breakdown {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .status-item,
        .priority-item,
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .status-item:last-child,
        .priority-item:last-child,
        .category-item:last-child {
            border-bottom: none;
        }

        .status-color,
        .priority-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        /* Status colors matching tasks.html */
        .status-color.pending { background: var(--secondary-color); }
        .status-color.in-progress { background: var(--warning-color); }
        .status-color.completed { background: var(--success-color); }

        /* Priority colors */
        .priority-color.high { background: var(--error-color); }
        .priority-color.medium { background: var(--warning-color); }
        .priority-color.low { background: var(--success-color); }

        .status-label,
        .priority-label,
        .category-label {
            flex: 1;
            font-weight: 500;
        }

        .status-count,
        .priority-count,
        .category-count {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Timeline */
        .timeline-chart {
            background: var(--card-background);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .timeline-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: var(--background-color);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-primary);
        }

        .week-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .week-item:hover {
            background-color: rgba(79, 70, 229, 0.02);
        }

        .week-item:last-child {
            border-bottom: none;
        }

        /* Activity Heatmap */
        .heatmap-container {
            background: var(--card-background);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .heatmap-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 2px;
            max-width: 600px;
            margin: 0 auto 1.5rem auto;
        }

        .heatmap-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .heatmap-day:hover {
            transform: scale(1.2);
        }

        .heatmap-day.level-0 { background: #ebedf0; }
        .heatmap-day.level-1 { background: #c6e48b; }
        .heatmap-day.level-2 { background: #7bc96f; }
        .heatmap-day.level-3 { background: #239a3b; }
        .heatmap-day.level-4 { background: #196127; }

        .heatmap-legend {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-colors {
            display: flex;
            gap: 2px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 1px;
        }

        .legend-color.level-0 { background: #ebedf0; }
        .legend-color.level-1 { background: #c6e48b; }
        .legend-color.level-2 { background: #7bc96f; }
        .legend-color.level-3 { background: #239a3b; }
        .legend-color.level-4 { background: #196127; }

        /* Auth Status */
        #auth-status {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .analytics-page {
                padding: 0 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .timeline-header,
            .week-item {
                grid-template-columns: 2fr 1fr 1fr 1fr;
                font-size: 0.9rem;
                padding: 0.75rem 1rem;
            }
            
            .heatmap-grid {
                grid-template-columns: repeat(7, 1fr);
            }
        }

        @media (max-width: 480px) {
            .page-header h1 {
                font-size: 2rem;
            }

            .stat-card {
                padding: 1.5rem;
            }

            .chart-card {
                padding: 1rem;
            }
        }
    </style>
    
    <!-- Firebase Scripts -->
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="main-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="breadcrumb">
                        <a href="dashboard.html">Dashboard</a> 
                        <span class="breadcrumb-separator">></span>
                        <span>Analytics</span>
                    </div>
                </div>
                <div class="header-right">
                    <div id="auth-status">
                        <!-- Auth status will be rendered here -->
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="analytics-page">
                <div class="page-header">
                    <h1>📊 Analytics Dashboard</h1>
                    <p>Comprehensive overview of your internship progress and task management</p>
                </div>

                <!-- Analytics Filter Tabs -->
                <div class="analytics-filter-tabs">
                    <div class="filter-tabs">
                        <button class="filter-tab active" data-filter="all">
                            <span class="tab-icon">📊</span>
                            <span class="tab-text">All Data</span>
                        </button>
                        <button class="filter-tab" data-filter="internship">
                            <span class="tab-icon">🎓</span>
                            <span class="tab-text">Internship</span>
                        </button>
                        <button class="filter-tab" data-filter="personal">
                            <span class="tab-icon">👤</span>
                            <span class="tab-text">Personal</span>
                        </button>
                    </div>
                </div>

                <!-- Overview Stats -->
                <section class="stats-section">
                    <h2>📈 Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">📝</div>
                            <div class="stat-content">
                                <h3 id="total-memos-stat">0</h3>
                                <p>Total Memos</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📋</div>
                            <div class="stat-content">
                                <h3 id="total-tasks-stat">0</h3>
                                <p>Total Tasks</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">⏱️</div>
                            <div class="stat-content">
                                <h3 id="total-hours-stat">0</h3>
                                <p>Hours Logged</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🗓️</div>
                            <div class="stat-content">
                                <h3 id="active-days-stat">0</h3>
                                <p>Active Days</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Task Analytics -->
                <section class="task-analytics-section">
                    <h2>📊 Task Analytics</h2>
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>Task Completion Rate</h3>
                            <div class="completion-chart">
                                <div class="circular-progress">
                                    <svg width="120" height="120">
                                        <circle cx="60" cy="60" r="50" stroke="#e9ecef" stroke-width="10" fill="transparent"/>
                                        <circle cx="60" cy="60" r="50" stroke="#28a745" stroke-width="10" fill="transparent"
                                                stroke-dasharray="314" stroke-dashoffset="314" id="progress-circle"/>
                                    </svg>
                                    <div class="progress-percentage" id="completion-percentage">0%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3>Tasks by Status</h3>
                            <div class="status-breakdown">
                                <div class="status-item">
                                    <span class="status-color pending"></span>
                                    <span class="status-label">Pending</span>
                                    <span class="status-count" id="todo-status-count">0</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-color in-progress"></span>
                                    <span class="status-label">In Progress</span>
                                    <span class="status-count" id="in-progress-status-count">0</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-color completed"></span>
                                    <span class="status-label">Completed</span>
                                    <span class="status-count" id="done-status-count">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3>Tasks by Priority</h3>
                            <div class="priority-breakdown">
                                <div class="priority-item">
                                    <span class="priority-color critical"></span>
                                    <span class="priority-label">Critical</span>
                                    <span class="priority-count" id="critical-priority-count">0</span>
                                </div>
                                <div class="priority-item">
                                    <span class="priority-color high"></span>
                                    <span class="priority-label">High</span>
                                    <span class="priority-count" id="high-priority-count">0</span>
                                </div>
                                <div class="priority-item">
                                    <span class="priority-color medium"></span>
                                    <span class="priority-label">Medium</span>
                                    <span class="priority-count" id="medium-priority-count">0</span>
                                </div>
                                <div class="priority-item">
                                    <span class="priority-color low"></span>
                                    <span class="priority-label">Low</span>
                                    <span class="priority-count" id="low-priority-count">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3>Category Distribution</h3>
                            <div class="category-breakdown" id="category-breakdown">
                                <!-- Categories will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Progress Timeline -->
                <section class="timeline-section">
                    <h2>📅 Weekly Progress</h2>
                    <div class="timeline-chart">
                        <div class="timeline-header">
                            <span>Week</span>
                            <span>Memos</span>
                            <span>Tasks</span>
                            <span>Hours</span>
                        </div>
                        <div id="weekly-timeline">
                            <!-- Weekly data will be populated here -->
                        </div>
                    </div>
                </section>

                <!-- Activity Heatmap -->
                <section class="heatmap-section">
                    <h2>🔥 Activity Heatmap</h2>
                    <div class="heatmap-container">
                        <p class="heatmap-description">Daily activity over the past 12 weeks</p>
                        <div class="heatmap-grid" id="activity-heatmap">
                            <!-- Heatmap will be generated here -->
                        </div>
                        <div class="heatmap-legend">
                            <span>Less</span>
                            <div class="legend-colors">
                                <div class="legend-color level-0"></div>
                                <div class="legend-color level-1"></div>
                                <div class="legend-color level-2"></div>
                                <div class="legend-color level-3"></div>
                                <div class="legend-color level-4"></div>
                            </div>
                            <span>More</span>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        
        // Make Firebase available globally
        window.Firebase = {
            initializeApp,
            getAuth,
            getFirestore
        };
    </script>

    <!-- Scripts -->
    <script type="module">
        import { 
            collection, 
            getDocs, 
            query, 
            orderBy, 
            onSnapshot,
            where 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        
        import { 
            onAuthStateChanged,
            signOut 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        
        // Import UI components
        // import { uiComponents } from './js/ui-components.js';
        
        // Simple confirmation dialog utility
        function showConfirmDialog(message, onConfirm) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); display: flex; align-items: center;
                justify-content: center; z-index: 10000;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white; padding: 2rem; border-radius: 8px;
                max-width: 400px; margin: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <p style="margin: 0 0 1.5rem 0; color: #374151;">${message}</p>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button id="cancel-btn" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button id="confirm-btn" style="padding: 0.75rem 1.5rem; border: none; background: #ef4444; color: white; border-radius: 4px; cursor: pointer;">Confirm</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            modal.querySelector('#cancel-btn').onclick = () => document.body.removeChild(overlay);
            modal.querySelector('#confirm-btn').onclick = () => {
                document.body.removeChild(overlay);
                onConfirm();
            };
            
            overlay.onclick = (e) => {
                if (e.target === overlay) document.body.removeChild(overlay);
            };
        }

        class AnalyticsDashboard {
            constructor() {
                this.memos = [];
                this.tasks = [];
                this.isInitialized = false;
                this.db = null;
                this.auth = null;
                this.currentUser = null;
                this.currentFilter = 'all'; // Add filter tracking
            }

            async initialize() {
                try {
                    // Wait for Firebase to be available
                    await this.waitForFirebase();
                    
                    // Initialize Firebase using centralized service
                    try {
                        // Import centralized Firebase service
                        const { initializeFirebase: initFirebase } = await import('./js/firebase-service.js');
                        
                        // Initialize Firebase using centralized config (no API key duplication!)
                        const { auth, db } = await initFirebase();
                        this.auth = auth;
                        this.db = db;
                        
                        console.log('Firebase initialized successfully using centralized service');
                    } catch (error) {
                        console.error('Failed to initialize Firebase service:', error);
                        throw error;
                    }
                    
                    // Check current auth state immediately
                    console.log('Current user on page load:', this.auth.currentUser);
                    
                    // Setup auth state listener
                    onAuthStateChanged(this.auth, async (user) => {
                        console.log('Auth state changed. User:', user ? user.email : 'No user');
                        
                        if (user) {
                            console.log('User authenticated:', user.email);
                            this.currentUser = user;
                            this.setupAuthUI();
                            this.setupFilters(); // Add filter setup
                            await this.loadData();
                            this.renderAnalytics();
                        } else {
                            console.log('No user authenticated. Auth state:', this.auth.currentUser);
                            
                            // Wait a bit to see if auth state is still loading
                            setTimeout(() => {
                                if (!this.auth.currentUser) {
                                    console.log('Still no user after timeout, redirecting to login...');
                                    window.location.href = 'login.html';
                                }
                            }, 1000);
                        }
                    });
                    
                    this.isInitialized = true;
                    console.log('Analytics dashboard initialized');
                    
                } catch (error) {
                    console.error('Failed to initialize analytics dashboard:', error);
                    this.showError('Failed to load analytics data: ' + error.message);
                }
            }

            async waitForFirebase() {
                let attempts = 0;
                const maxAttempts = 50;
                
                while (!window.Firebase && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.Firebase) {
                    throw new Error('Firebase not available after waiting');
                }
            }

            setupAuthUI() {
                const authStatus = document.getElementById('auth-status');
                if (this.currentUser && authStatus) {
                    authStatus.innerHTML = `
                        <span>Welcome, ${this.currentUser.displayName || this.currentUser.email}</span>
                        <button id="sign-out-btn" style="margin-left: 1rem; background: rgba(239, 68, 68, 0.9); border: 1px solid rgba(239, 68, 68, 0.7); color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500;">
                            🚪 Sign Out
                        </button>
                    `;
                    
                    // Add event listener for sign out button
                    document.getElementById('sign-out-btn').addEventListener('click', () => {
                        this.handleSignOut();
                    });
                }
            }

            setupFilters() {
                const filterTabs = document.querySelectorAll('.filter-tab');
                
                filterTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active class from all tabs
                        filterTabs.forEach(t => t.classList.remove('active'));
                        
                        // Add active class to clicked tab
                        tab.classList.add('active');
                        
                        // Update current filter
                        this.currentFilter = tab.dataset.filter;
                        
                        // Re-render analytics with new filter
                        this.renderAnalytics();
                    });
                });
            }

            // Handle sign out with confirmation
            async handleSignOut() {
                showConfirmDialog(
                    'Are you sure you want to sign out? Make sure all your changes are saved.',
                    async () => {
                        try {
                            await signOut(this.auth);
                            window.location.href = 'login.html';
                        } catch (error) {
                            console.error('Sign out error:', error);
                        }
                    }
                );
            }

            async loadData() {
                try {
                    if (!this.currentUser) return;

                    // Load memos
                    await this.loadMemos();
                    
                    // Load tasks
                    await this.loadTasks();
                    
                    console.log('Data loaded:', { 
                        memos: this.memos.length, 
                        tasks: this.tasks.length 
                    });
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showError('Error loading data: ' + error.message);
                }
            }

            async loadMemos() {
                try {
                    if (!this.currentUser) {
                        console.log('No user authenticated for loading memos');
                        this.memos = [];
                        return;
                    }
                    
                    console.log('Loading memos for user:', this.currentUser.uid);
                    const memosRef = collection(this.db, `users/${this.currentUser.uid}/memos`);
                    const memosQuery = query(memosRef, orderBy('date', 'desc'));
                    const snapshot = await getDocs(memosQuery);
                    
                    this.memos = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    console.log(`Loaded ${this.memos.length} memos:`, this.memos);
                } catch (error) {
                    console.error('Error loading memos:', error);
                    this.memos = [];
                }
            }

            async loadTasks() {
                try {
                    if (!this.currentUser) {
                        console.log('No user authenticated for loading tasks');
                        this.tasks = [];
                        return;
                    }
                    
                    console.log('Loading tasks for user:', this.currentUser.uid);
                    const tasksRef = collection(this.db, `users/${this.currentUser.uid}/tasks`);
                    const tasksQuery = query(tasksRef, orderBy('createdAt', 'desc'));
                    const snapshot = await getDocs(tasksQuery);
                    
                    this.tasks = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    console.log(`Loaded ${this.tasks.length} tasks:`, this.tasks);
                } catch (error) {
                    console.error('Error loading tasks:', error);
                    this.tasks = [];
                }
            }

            // Filter methods
            getFilteredMemos() {
                if (this.currentFilter === 'all') {
                    return this.memos;
                } else if (this.currentFilter === 'internship') {
                    return this.memos.filter(memo => memo.category && memo.category.startsWith('internship-'));
                } else if (this.currentFilter === 'personal') {
                    return this.memos.filter(memo => memo.category && memo.category.startsWith('personal-'));
                }
                return this.memos;
            }

            getFilteredTasks() {
                // For now, tasks don't have categories, so return all tasks
                // You could enhance this later if tasks get category support
                return this.tasks;
            }

            renderAnalytics() {
                console.log(`Rendering analytics with filter: ${this.currentFilter}`);
                console.log(`Total data: ${this.memos.length} memos, ${this.tasks.length} tasks`);
                
                this.renderOverviewStats();
                this.renderTaskAnalytics();
                this.renderWeeklyProgress();
                this.renderActivityHeatmap();
            }

            renderOverviewStats() {
                // Get filtered data
                const filteredMemos = this.getFilteredMemos();
                const filteredTasks = this.getFilteredTasks();
                
                // Calculate stats from filtered data
                const totalMemos = filteredMemos.length;
                const totalTasks = filteredTasks.length;
                const totalHours = filteredMemos.reduce((sum, memo) => {
                    const duration = parseFloat(memo.duration) || 0;
                    return sum + duration;
                }, 0);
                const activeDays = new Set(filteredMemos.map(memo => memo.date)).size;

                // Update DOM
                const totalMemosEl = document.getElementById('total-memos-stat');
                const totalTasksEl = document.getElementById('total-tasks-stat');
                const totalHoursEl = document.getElementById('total-hours-stat');
                const activeDaysEl = document.getElementById('active-days-stat');

                if (totalMemosEl) totalMemosEl.textContent = totalMemos.toLocaleString();
                if (totalTasksEl) totalTasksEl.textContent = totalTasks.toLocaleString();
                if (totalHoursEl) totalHoursEl.textContent = Math.round(totalHours).toLocaleString();
                if (activeDaysEl) activeDaysEl.textContent = activeDays.toLocaleString();
            }

            renderTaskAnalytics() {
                if (this.tasks.length === 0) {
                    // Show empty state
                    document.getElementById('completion-percentage').textContent = '0%';
                    return;
                }

                // Task completion rate (matching tasks.html status values)
                const completedTasks = this.tasks.filter(task => task.status === 'completed').length;
                const completionRate = Math.round((completedTasks / this.tasks.length) * 100);
                
                const completionEl = document.getElementById('completion-percentage');
                if (completionEl) {
                    completionEl.textContent = completionRate + '%';
                }
                
                // Update progress circle
                const circle = document.getElementById('progress-circle');
                if (circle) {
                    const circumference = 314;
                    const offset = circumference - (completionRate / 100) * circumference;
                    circle.style.strokeDashoffset = offset;
                }

                // Status breakdown (matching tasks.html status values)
                const statusCounts = this.tasks.reduce((acc, task) => {
                    const status = task.status || 'pending';
                    acc[status] = (acc[status] || 0) + 1;
                    return acc;
                }, {});

                // Map status values to UI elements
                const pendingEl = document.getElementById('todo-status-count');
                const inProgressEl = document.getElementById('in-progress-status-count');
                const completedEl = document.getElementById('done-status-count');

                if (pendingEl) pendingEl.textContent = statusCounts['pending'] || 0;
                if (inProgressEl) inProgressEl.textContent = statusCounts['in-progress'] || 0;
                if (completedEl) completedEl.textContent = statusCounts['completed'] || 0;

                // Priority breakdown (matching tasks.html priority values)
                const priorityCounts = this.tasks.reduce((acc, task) => {
                    const priority = task.priority || 'medium';
                    acc[priority] = (acc[priority] || 0) + 1;
                    return acc;
                }, {});

                // Update priority counts (skip critical as it's not used in tasks.html)
                const highEl = document.getElementById('high-priority-count');
                const mediumEl = document.getElementById('medium-priority-count');
                const lowEl = document.getElementById('low-priority-count');

                if (highEl) highEl.textContent = priorityCounts['high'] || 0;
                if (mediumEl) mediumEl.textContent = priorityCounts['medium'] || 0;
                if (lowEl) lowEl.textContent = priorityCounts['low'] || 0;

                // Hide critical priority as it's not used in tasks.html
                const criticalEl = document.getElementById('critical-priority-count');
                if (criticalEl) {
                    criticalEl.textContent = '0';
                    criticalEl.closest('.priority-item').style.display = 'none';
                }

                // Category breakdown
                this.renderCategoryBreakdown();
            }

            renderCategoryBreakdown() {
                // Use filtered memos instead of tasks for category breakdown
                const filteredMemos = this.getFilteredMemos();
                
                const categoryCounts = filteredMemos.reduce((acc, memo) => {
                    let category = memo.category || 'Other';
                    
                    // Format category display name for new category system
                    let displayCategory = category;
                    if (category.startsWith('internship-')) {
                        displayCategory = '🎓 ' + category.replace('internship-', '').split('-').map(word => 
                            word.charAt(0).toUpperCase() + word.slice(1)
                        ).join(' ');
                    } else if (category.startsWith('personal-')) {
                        displayCategory = '👤 ' + category.replace('personal-', '').split('-').map(word => 
                            word.charAt(0).toUpperCase() + word.slice(1)
                        ).join(' ');
                    } else {
                        // Legacy categories
                        displayCategory = category.charAt(0).toUpperCase() + category.slice(1);
                    }
                    
                    acc[displayCategory] = (acc[displayCategory] || 0) + 1;
                    return acc;
                }, {});

                const container = document.getElementById('category-breakdown');
                if (!container) return;
                
                container.innerHTML = '';

                if (Object.keys(categoryCounts).length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No categories found</p>';
                    return;
                }

                // Sort categories by count (descending)
                const sortedCategories = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]);

                sortedCategories.forEach(([category, count]) => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item';
                    categoryItem.innerHTML = `
                        <span class="category-label">${category}</span>
                        <span class="category-count">${count}</span>
                    `;
                    container.appendChild(categoryItem);
                });
            }

            renderWeeklyProgress() {
                const weeks = this.getWeeklyData();
                const container = document.getElementById('weekly-timeline');
                if (!container) return;
                
                container.innerHTML = '';

                if (weeks.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--text-secondary);">No weekly data available</p>';
                    return;
                }

                // Add some visual enhancements and date labels
                const now = new Date();
                weeks.forEach((week, index) => {
                    const weekStartDate = new Date(now);
                    weekStartDate.setDate(weekStartDate.getDate() - ((7 - index) * 7) - now.getDay());
                    
                    const weekItem = document.createElement('div');
                    weekItem.className = 'week-item';
                    
                    const weekLabel = index === weeks.length - 1 ? 'This Week' : 
                                     index === weeks.length - 2 ? 'Last Week' :
                                     `${8 - index} weeks ago`;
                    
                    weekItem.innerHTML = `
                        <span class="week-label">${weekLabel}</span>
                        <span class="week-memos">${week.memos}</span>
                        <span class="week-tasks">${week.tasks}</span>
                        <span class="week-hours">${week.hours}h</span>
                    `;
                    
                    // Add some visual feedback for active weeks
                    if (week.memos > 0 || week.tasks > 0) {
                        weekItem.style.background = 'linear-gradient(135deg, #f0f9ff, #e0f2fe)';
                        weekItem.style.border = '1px solid #bae6fd';
                    }
                    
                    container.appendChild(weekItem);
                });
            }

            renderActivityHeatmap() {
                const heatmapData = this.generateHeatmapData();
                const container = document.getElementById('activity-heatmap');
                if (!container) return;
                
                container.innerHTML = '';

                if (heatmapData.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--text-secondary);">No activity data available</p>';
                    return;
                }

                heatmapData.forEach(day => {
                    const dayCell = document.createElement('div');
                    dayCell.className = `heatmap-day level-${day.level}`;
                    
                    // Enhanced tooltip with better formatting
                    const date = new Date(day.date);
                    const dateStr = date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        weekday: 'short'
                    });
                    
                    dayCell.title = `${dateStr}: ${day.activities} ${day.activities === 1 ? 'activity' : 'activities'}`;
                    
                    // Add click handler for future detailed view
                    dayCell.addEventListener('click', () => {
                        console.log(`Clicked on ${day.date} with ${day.activities} activities`);
                        // You could add a detailed view modal here in the future
                    });
                    
                    container.appendChild(dayCell);
                });
                
                console.log(`Rendered ${heatmapData.length} heatmap cells`);
            }

            getWeeklyData() {
                // Generate weekly data for the past 8 weeks using filtered data
                const weeks = [];
                const now = new Date();
                const filteredMemos = this.getFilteredMemos();
                const filteredTasks = this.getFilteredTasks();
                
                console.log(`Generating weekly data with ${filteredMemos.length} memos and ${filteredTasks.length} tasks`);
                
                for (let i = 7; i >= 0; i--) {
                    const weekStart = new Date(now);
                    weekStart.setDate(weekStart.getDate() - (i * 7) - now.getDay()); // Start from Sunday
                    weekStart.setHours(0, 0, 0, 0); // Start of day
                    
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    weekEnd.setHours(23, 59, 59, 999); // End of day

                    const weekStartStr = weekStart.toISOString().split('T')[0];
                    const weekEndStr = weekEnd.toISOString().split('T')[0];

                    const weekMemos = filteredMemos.filter(memo => {
                        if (!memo.date) return false;
                        return memo.date >= weekStartStr && memo.date <= weekEndStr;
                    });

                    const weekTasks = filteredTasks.filter(task => {
                        if (!task.createdAt) return false;
                        const taskDate = task.createdAt.toDate ? 
                            task.createdAt.toDate().toISOString().split('T')[0] :
                            new Date(task.createdAt).toISOString().split('T')[0];
                        return taskDate >= weekStartStr && taskDate <= weekEndStr;
                    });

                    const totalHours = weekMemos.reduce((sum, memo) => sum + (parseFloat(memo.duration) || 0), 0);

                    weeks.push({
                        memos: weekMemos.length,
                        tasks: weekTasks.length,
                        hours: Math.round(totalHours * 10) / 10 // Round to 1 decimal place
                    });
                }

                console.log('Weekly data generated:', weeks);
                return weeks;
            }

            generateHeatmapData() {
                const days = [];
                const now = new Date();
                const startDate = new Date(now);
                startDate.setDate(startDate.getDate() - 84); // 12 weeks
                startDate.setHours(0, 0, 0, 0);
                
                const filteredMemos = this.getFilteredMemos();
                const filteredTasks = this.getFilteredTasks();
                
                console.log(`Generating heatmap with ${filteredMemos.length} memos and ${filteredTasks.length} tasks`);

                for (let i = 0; i < 84; i++) {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + i);
                    
                    const dateString = date.toISOString().split('T')[0];
                    
                    const dayMemos = filteredMemos.filter(memo => {
                        return memo.date && memo.date === dateString;
                    }).length;
                    
                    const dayTasks = filteredTasks.filter(task => {
                        if (!task.createdAt) return false;
                        const taskDate = task.createdAt.toDate ? 
                            task.createdAt.toDate().toISOString().split('T')[0] :
                            new Date(task.createdAt).toISOString().split('T')[0];
                        return taskDate === dateString;
                    }).length;

                    const activities = dayMemos + dayTasks;
                    // Improved level calculation: 0 activities = level 0, 1-2 = level 1, 3-4 = level 2, etc.
                    const level = activities === 0 ? 0 : Math.min(Math.ceil(activities / 2), 4);

                    days.push({
                        date: dateString,
                        activities,
                        level
                    });
                }

                console.log(`Heatmap data generated: ${days.length} days`);
                return days;
            }

            showError(message) {
                console.error(message);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                document.querySelector('.analytics-page').prepend(errorDiv);
            }
        }

        // Initialize the dashboard and make it globally available
        window.dashboard = new AnalyticsDashboard();
        window.dashboard.initialize();
    </script>
</body>
</html>
    </script>
</body>
</html>
